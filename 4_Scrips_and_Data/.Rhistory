# Author:
# Juan Bettinelli,
# Script that preformes a Keeling analyse of the CH4 Measuments at the Geomatikum
# The the Analyse is done depending on the wind direction.
# The Peaks kan be seen seperatel.
# 27.2.2023
# Declare librarys used
library(pacman)
library(lubridate)
library(readr)
library(plyr)
library(tidyverse)
library(ggplot2)
library(hexbin)
library(gridExtra)
library(dplyr)
library(GGally)
library(ggthemes)
library(ggvis)
library(httr)
library(lubridate)
library(plotly)
library(rio)
library(rmarkdown)
library(shiny)
library(stringr)
library(tidyr)
library(gridExtra)
library(grid)
library(PlaneGeometry)
# Set Working Directory
setwd("/Users/juanbettinelli/Documents/Uni/MasterThesis/4_Scrips_and_Data")
## Select the dates to be analyed
# Set Starting and Finish Time
StartTime <- as.POSIXct('2021-08-01 22:03:00',
format = "%Y-%m-%d %H:%M:%S",
tz ="utc")
# Start Time: 2021-08-01 22:03:00
FinishTime <- as.POSIXct('2022-03-29 00:00:00',
format = "%Y-%m-%d %H:%M:%S",
tz ="utc")
# Total Timeseries: 2022-03-29 00:00:00
# Hamburg Campagne Timeseries: 2021-09-06 00:00:00
# Hamburg Campaine #2: 2021-09-17 10:21:00
Wind_Provider = 1 # Wind_Provider = 1(Geomatikum), 2(Mast 50m) 3(Mast 110m), 4(DWD)
# Values taken from literature as seen below:
# "Characterisation of methane sources in Lutjewad, The Netherlands, using quasi-continuous isotopic composition measurements"
## Creating elipses of emission sorces to use in the plots
# Extraction and distribution of fossil fuels & nonindustrial combustion 12C 40.0 [66.4; 30.9], 2H 175 [199; 175]
FF <- Ellipse$new(center = c(-40.0, -198.5), rmajor = 17.75, rminor = 12, alpha = 0)
# ellipse as a path
FFpath <- FF$path()
# the path is not closed; close it
FFpath <- rbind(FFpath, FFpath[1,])
# Agriculture 12C 68.0 [70.6; 46.0] 2H 319 [361; 295]
AG <- Ellipse$new(center = c(-68.0, -319), rmajor = 33 , rminor = 12.3, alpha = 90)
# ellipse as a path
AGpath <- AG$path()
# the path is not closed; close it
AGpath <- rbind(AGpath, AGpath[1,])
# Waste 12C 55 [73.9; 45.5], 2H 293 [312; 293]
WA <- Ellipse$new(center = c(-55, -293), rmajor =  28.4, rminor = 9.5 , alpha = 0)
# ellipse as a path
WApath <- WA$path()
# the path is not closed; close it
WApath <- rbind(WApath, WApath[1,])
# Other anthropogenic sources 12C 35.0 [60; 9], 2H 175 [175; 81]
OA <- Ellipse$new(center = c(-35, -175), rmajor =  28.4, rminor = 9.5 , alpha = 0)
# ellipse as a path
OApath <- OA$path()
# the path is not closed; close it
OApath <- rbind(OApath, OApath[1,])
# Natural wetlands 12C 69 [88.9; 51.5], 2H 330 [358; 246]
WL <- Ellipse$new(center = c(-69, -330), rmajor =  56 , rminor = 18.7 , alpha = 90)
# ellipse as a path
WLpath <- WL$path()
# the path is not closed; close it
WLpath <- rbind(WLpath, WLpath[1,])
## Create Ploygon to be used in the Plots
# Thermogenic
TH <- data.frame(x = c(-75, -40, -15, -40, -60), y = c(-350, -100, -150, -300, -350))
# Abiotic
A <- data.frame(x = c(-50, -50, -25, -10, -10), y = c(-450, -300, -50, -50, -450))
########### Read data from the CSV File #############
# Read the CSV File
TotalData <- import("4_Data/OutputData/CombineMeteorologicalData.csv")
# format the Date 'UTC'
TotalData$UTC <- as.POSIXct(as.character(TotalData$UTC),
format = "%Y-%m-%d %H:%M:%S",
tz = "UTC")
# Convert the format of 'X.CH4.' to numeric
TotalData$X.CH4. <- as.numeric(TotalData$X.CH4.)
# Filter out all the dated that are outside the selected Starting and Finish time of the campaign
TotalData <- filter(TotalData, TotalData$UTC > StartTime & TotalData$UTC < FinishTime, .preserve = FALSE)
# Remove Empty Cells n data frame
TotalData <- TotalData[!is.na(TotalData$UTC),]
# Calculate 1/Mole Fraction for C13 & H2 for the Keeling analyse and add as new column
TotalData$c13C <- 1/TotalData$X.CH4..13C
TotalData$c2H <- 1/TotalData$X.CH4..2H
# Create a dataframe with only the Methan Data
CH4Data <- TotalData[, c("UTC", "X.CH4..13C", "d13C.VPDB", "sd..CH4.", "sd.d13C", "X.CH4..2H", "d2H.VPDB", "sd..CH4..1", "sd.d2H", "X.CH4.", "c13C", "c2H")]
CH4Data <- CH4Data[complete.cases(CH4Data[ , "X.CH4."]),]
# Add New empty columns for the wind speed and direction.
CH4Data[,"Speed"] <- NA
CH4Data[,"Direction"] <- NA
# Select the Wind data provided by Uni. Hamburg or DWD
if (Wind_Provider == 1){
# Geomatikum
W_Speed <- "Speed"
W_Direction <- "Direction"
}
else if (Wind_Provider == 2){
